apiVersion: kuttl.dev/v1beta1
kind: TestAssert
timeout: 30
commands:
  - script: |
      echo "Checking all running pods have new nodeselector"
      EXPECTED_NODE_SELECTOR="kubernetes.io/os:linux"
      BAD_OR_MISSING_NODE_SELECTOR=$(oc get pods -n $NAMESPACE --field-selector=status.phase=Running -o=go-template --template='{{ range .items }}{{ .metadata.name}}: {{ .spec.nodeSelector }}{{"\n"}}{{ end }}' | sed -e '\!map\['"$EXPECTED_NODE_SELECTOR"'\]$!d')
      BAD_OR_MISSING_NODE_SELECTOR_COUNT=$(echo "$BAD_OR_MISSING_NODE_SELECTOR" | wc -l)
      if [ $BAD_OR_MISSING_NODE_SELECTOR_COUNT -ne 0 ]; then
        echo "Found $BAD_OR_MISSING_NODE_SELECTOR_COUNT pods with bad or missing nodeselector:"
        echo "$BAD_OR_MISSING_NODE_SELECTOR"
        exit 1
      fi
